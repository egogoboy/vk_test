# Логгер на C++
Библиотека для записи логов в файл. Позволяет добавлять собственные метрики и удобно использовать их в программе.

## Туториал
### Регистр метрик
Для создания метрик необходимо создать MetricRegistry - регистр, содержащий в себе метрики
```C++
metrics::MetricRegistry registry
```

### Создание метрик
После создания регистра в нём можно создавать Metric. Каждая метрика имеет название, тип значений, а также режим записи `Snapshot` или `Buffered`
```C++
auto cpu = registry.create_metric<double, metrics::MetricBuffered>("CPU");
auto http = registry.create_metric<int>("HTTP requests RPS); // по умолчанию тип метрики - metrics::MetricSnapshot
```

#### Типы метрик
Выше было написано про два режима записи метрик `Snapshot` и `Buffered`.
##### Snapshot-метрика
Запись значения такой метрики происходит непосредственно в момент работы `MetricWriter`. Выводится только находившееся на данный момент значение в метрике.
##### Buffered-метрика
Запись также происходится в момент работы `MetricWriter`. Однако, данный тип метрик накапливает значения до вызова метода `MetricBuffered.collect()`. После этого хранилище очищается, а `MetricWriter` выведет полученные значения.

### Запись метрик
Теперь, для того, чтобы производить запись метрик, необходимо создать `MetricWriter` и передать ему в конструкторе наш `MetricRegistry`
```C++
metrics::MetricWriter writer(registry, "metrics.txt", 1000, 100);
```
Кроме регистра мы передаём:
- Имя файла для записи метрик
- Частоту записи метрик в мс
- Округление времени в мс

В нашем примере `writer` будет записывать метрики в файл с частотой в 1 секунду и не будет время до 100 мс. 
По умолчанию частота записи равна 1000 мс, а округление - 1 мс (то есть без округления).

Для того, чтобы `writer` начал запись необходимо вызвать метод `writer.start()`. Если передать методу параметр `true`:
```C++
writer.start(true);
```
То помимо записи в файл метрики будут дублироваться в консоль (создавалось больше для отладки, но, мало ли, будет необходимо.

Для остановки записи можно вызвать метод `writer.stop()`. После этого поток дозапишет накопленные метрики и остановится. Данный метод вызывается в деструкторе.

### Добавление значений в метрики
Для добавления значений у метрики необходимо вызвать метод `add()`.
```C++
cpu->add(0.5);
http->add(67);
```

### Пример вывода для описанного выше примера
```bash
2025-06-16 19:28:45.700 "CPU" 0.506000
2025-06-16 19:28:45.800 "CPU" 0.519000
2025-06-16 19:28:45.900 "CPU" 0.528000
2025-06-16 19:28:46.000 "CPU" 0.532000
2025-06-16 19:28:46.100 "CPU" 0.503000
2025-06-16 19:28:46.200 "CPU" 0.570000
2025-06-16 19:28:46.400 "CPU" 0.508000
2025-06-16 19:28:46.500 "CPU" 0.540000
2025-06-16 19:28:46.600 "CPU" 0.596000
2025-06-16 19:28:46.700 "CPU" 0.518000 "HTTP requests RPS" 55
2025-06-16 19:28:46.800 "CPU" 0.546000
2025-06-16 19:28:46.900 "CPU" 0.521000
2025-06-16 19:28:47.000 "CPU" 0.579000
2025-06-16 19:28:47.100 "CPU" 0.564000
2025-06-16 19:28:47.200 "CPU" 0.541000
2025-06-16 19:28:47.300 "CPU" 0.593000
2025-06-16 19:28:47.400 "CPU" 0.534000
2025-06-16 19:28:47.500 "CPU" 0.524000
2025-06-16 19:28:47.600 "CPU" 0.587000
2025-06-16 19:28:47.700 "HTTP requests RPS" 56
2025-06-16 19:28:47.700 "CPU" 0.543000
```
Если обратить внимание на последние две строки, можно увидеть, что две, казалось бы одинаковые метрики не объединились в одну. Это происходит из-за округления времени. По факту эти значения были добавлены, например, в такое время:
```bash
2025-06-16 19:28:47.721 "HTTP requests RPS" 56
2025-06-16 19:28:47.789 "CPU" 0.543000
```
А `MetricWriter` отработал где-то между ними. Получается, что метрики с "CPU" не существовало на момент записи. В будущем можно попробовать исправить эту проблему. Например, сохранять в памяти последние метрики и при получении новых пытаться объединить совпадающие.

В `tests/test_main.cpp` написан пример использования логгера.

### Сборка и запуск примера
```bash
git clone https://github.com/egogoboy/vk_test
md build
cd build
cmake ..
make
./tests/test_main
```
Логи лежат в metrics.txt
